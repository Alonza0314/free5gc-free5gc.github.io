# Mapping PCC Rules into QoS Flows: Policy Application in 5G Networks

>[!NOTE]
> Author: Alonza Tu
> Date: 2024/11/13
---

## Roles of PCC Rules and QoS Flows

In 5G networks, managing service quality for diverse applications is critical to providing users with a consistent experience. PCC, which stands for Policy and Charging Control, rules play a central role in regulating traffic flows, enforcing quality standards, and adapting network resources according to real-time conditions. To support this, Quality of Service (QoS) flows are used to manage traffic prioritization and resource allocation. This blog explains how PCC rules are mapped to QoS flows, describing each step of the process managed by the SMF with support from the UPF and the (R)AN.

## Key Components

- **PCC**:
  - **Policy Control**: Policy control involves defining rules and conditions that dictate how network resources should be allocated and managed.
  - **Charging Control**: Charging control involves determining how users are billed for the services they consume.
- **QoS**:
  - **QoS Flow Identifier(QFI)**: A QFI is a unique identifier assigned to each QoS Flow to distinguish it from other QoS flows in the network.
  - **QoS Profile**: A QoS profile is a set of parameters that define the service quality parameters and any associated priorities.
  ![qos-profile](./qos-porfile.png)
  - **QoS Flow**: A QoS flow is a logical channel with specific QoS characteristics that guarantee certain service levels for the data transported within it.

## Overview and Network Functions

- **PCF(Policy Control Function)**: The PCF is responsible for generating PCC rules based on the service requirements and network conditions.
- **SMF(Session Management Function)**: The SMF is responsible for translating PCC rules received from the PCF into actionable configurations on the user plane.
- **UPF(User Plane Function)**: The UPF enforces the PDRs based on the rules set by SMF.
- **(R)AN**: The (R)AN allocates appropriate resources to meet the QoS Flow's requirements.

## Mapping PCC Rules into QoS Flows

1. **SMF's Role in the QoS Flow Creation Process**
    The SMF is responsible for translating PCC rules received from the PCF into actionable configurations on the user plane. When the PCF procides a new PCC rule, the SMF evaluates the rules's quality requirements, service priorities, and any specific attributes(e.g., bandwidth or latency constraints) to generate a new QoS Flow.

    To describe this process, the SMF will:
    - Assigns a unique QoS Flow Identifier(QFI) to identify the QoS Flow.
    - Derives a QoS profile.
    - Generates QoS rules based on the PCC rule details, creating an explicit QoS rule set that will be communicated to the UE.

    [More details click here](#more-details-on-how-smf-works-on-creating-qos-flows)

2. **Distribution of QoS Flow Binding Information**
    Once the QoS Flow is created, the SMF distributes the QoS Flow's binding information to both the (R)AN and UPF. The SMF provides the following to the (R)AN:
    - The QFI, which identifies the QoS Flow.
    - The QoS profile. detailing the service quality parameters and any associated priorities.
    - Optional alternate QoS profiles that the  (R)AN can reference if conditions change.

    The SMF also configures the UPF to enforce the QoS parameters on user plane traffic by defining Packet Detection Rules(PDRs):
    - A Downlink(DL) PDR that contains the Service Data Flow(SDF) templates DL packet filters.
    - An Uplink(UL) PDR that contains the SDF template's UL packet filters.
    - Each PDR is assigned a precedence value that reflects the PCC rule’s priority, helping the UPF classify and control traffic flow accordingly.

3. **Mapping of PCC Rules to QoS Flows and QoS Rule Generation**
    PCC rules mapped to QoS Flows are used to generate explicit QoS rules, which are sent to the UE for traffic classification and prioritization. In this step, the SMF:
    - Assigns a unique QoS rule identifier within the PDU session.
    - Sets the QFI in the QoS rule to match the QFI of the QoS Flow.
    - Configures the QoS rule’s Packet Filter Set using the UL and optionally DL SDF filters from the PCC rule.
    - Sets the QoS rule precedence according to the PCC rule’s priority.

    These QoS rules allow the UE to classify traffic for the PDU session according to the PCC rule details, aligning with the service quality and resource requirements defined by the network.

4. **UE QoS Binding and Traffic Classification**
   At the UE level, each packet is evaluated against the UL Packet Filters in the QoS rules. Based on the precedence of each QoS rule, the UE identifies the appropriate QFI and binds the packet to the corresponding QoS Flow. The QoS Flow is then mapped to the AN resources, such as Data Radio Bearers in the 3GPP RAN, where network resources are allocated to meet the flow’s requirements.

    In the Downlink (DL) direction, the UPF classifies incoming data packets according to the DL PDR’s Packet Filter Sets, enforcing service quality before delivering packets to the UE.

5. **Dynamic Updates to PCC Rules and QoS Flows**
    As conditions in the network or service requirements change, the PCF may update the PCC rules, requiring SMF to update the QoS Flows. When this happens, the SMF modifies the explicit QoS rules(i.e., in decision) accordingly and notifies the UE with operations to add, modify, or delete QoS rules. For example, if the PCF signals a new QoS requirement due to handover or network condition changes, the SMF adjusts the QoS parameters or Flow assignments accordingly.

    This dynamic adaptability allows the SMF to provide the most efficient and reliable service quality while balancing network resources based on real-time needs.

## More Details on How SMF Works on Creating QoS Flows

1. Assigns a unique QoS Flow Identifier(QFI) to identify the QoS Flow.
   In 5G networks, each QoS Flow is assigned a unique QFI, which is used to identify the QoS Flow and distinguish it from other QoS Flows.
2. Generates a QoS profile.
   After the QFI is assigned, the SMF generates a QoS profile for each QoS Flow, which includes the service quality parameters in detail to meet the requirements of the PCC rule.
3. Creates QoS rules based on the PCC rule details.
   The creation of QoS rules is based on the detailed requirements of PCC rules, which transmit traffic classification and management strategies to the UE, thereby implementing traffic classification and resource allocation at the user level. The specific process is as follows:

    - Mapping QFI: In QoS rules, the system maps the QFI of each flow to specific packet filters, ensuring that traffic can be identified and the corresponding QoS configuration is applied when it enters the UPF or (R)AN.
    - Packet Filter Settings: QoS rules typically contain a set of packet filters that use specific markers (such as IP addresses or protocol types) to identify different data packets. This allows the terminal device to effectively distinguish traffic in the uplink direction and bind it to the correct QoS flow.
    - Priority Allocation: Based on the requirements of PCC rules, QoS rules assign different priorities, allowing the terminal device to process data packets according to the importance of the traffic. This priority allocation is also applied to the UPF when forwarding data packets in the downlink direction, ensuring reasonable allocation and efficient use of network resources.

## Conclusion

In summary, the SMF orchestrates the entire process of mapping PCC rules to QoS Flows, collaborating with the PCF, (R)AN, UPF, and UE to manage traffic flow and ensure service quality. The UPF enforces the PDRs based on the rules set by SMF, while the (R)AN allocates appropriate resources.

By effectively mapping PCC rules to QoS Flows, the SMF enables seamless, prioritized traffic flow management in 5G, paving the way for efficient, user-focused network service.

## Reference

- [TS 23.502](https://www.etsi.org/deliver/etsi_ts/123500_123599/123502/16.05.00_60/ts_123502v160500p.pdf)
- [TS 23.503](https://www.etsi.org/deliver/etsi_ts/123500_123599/123503/16.05.00_60/ts_123503v160500p.pdf)
- [TechSpec](https://itecspec.com/spec/3gpp-23-501-5-7-qos-model/)
- [Introduction to 5G Quality of Service (QoS)](https://free5gc.org/blog/20240628/20240628/)
- [核心網路的策略與計費](https://ithelp.ithome.com.tw/articles/10294723)

## About

Hello, I'm Alonza. This autumn, I’m excited to be joining the free5GC project with a lot of enthusiasm. I look forward to diving into the technical aspects of the 5G core network and growing my expertise in this cutting-edge field. My goal is to learn alongside the team, contribute meaningfully, and help advance the development of 5G technology together.

### Connect with Me

- GitHub: [https://github.com/Alonza0314](https://github.com/Alonza0314)
- Website: [Alonza0314](https://alonza0314.github.io/)
